{/capture name="title"/}{/$title/}{//capture/}
{/assign var="headnav" value=1/}
{/assign var="leftnav" value=array(10,10)/}
{/capture name="body"/}
<div class="crmchance-detail clearfix">
	<style type="text/css">
	.detail-main{
		padding-right: 280px;
	}

	.detail-main .nav{
		height: 37px;
	}

	.aside-right{
		float: right;
		width: 270px;
		margin-top: 40px;
	}

	.tab-section .title{
		height: 30px;
		font-size: 16px;
		font-weight: bold;
		line-height: 30px;
		border-left: 5px solid #0099ff;
		border-bottom: 1px solid #0099ff;
		padding-left: 5px;
	}

	.tab-section .title .list-inline .save,
	.tab-section .title .list-inline .cancel{
		display: none;
		visibility: hidden;
	}

	.tab-section .title .list-inline.business-edit .save,
	.tab-section .title .list-inline.business-edit .cancel{
		display: inline-block;
		visibility: visible;
	}

	.tab-section .title .list-inline.business-edit .edit{
		display: none;
		visibility: hidden;
	}

	.tab-section .title .list-inline li > a{
		font-size: 14px;
		font-weight: normal;
	}

	.tab-section .title .list-inline li > a > img{
		width: 18px;
		height: 18px;
	}

	.tab-section .title .list-inline li{
		display: none;
		visibility: hidden;
	}

	.tab-section .title .list-inline li.edit{
		display: inline-block;
		visibility: visible;
	}

	.tab-section .content{
		position: relative;
		margin: 10px 0 30px 0;
	}

	.tab-section .content.crmchance-info{
		border-left: 1px solid #ddd;
		border-bottom: 1px solid #ddd;
		margin-bottom: 15px;
	}

	.tab-section .content.crmchance-info .cover{
		display: none;
		position: absolute;
		left: 0;
		top: 0;
		right: 0;
		bottom: 0;
		background: rgba(255, 255, 255, 0.5) url(/assets/img/loading-small.gif) center center no-repeat;
	}
	.tab-section .content.crmchance-info + table{
		width: 100%;
		margin-bottom: 30px;
	}
	
	.tab-section .content .grid .grid-item-2{
		float: left;
		width: 16.66666667%;
	}

	.tab-section .content .grid .grid-item-4{
		float: left;
		width: 33.33333333%;
	}

	.tab-section .content .grid .grid-item-10{
		float: left;
		width: 83.33333333%;
	}

	.tab-section .content .grid > div{
		position: relative;
		height: 40px;
		line-height: 40px;
		border-top: 1px solid #ddd;
	}

	.tab-section .content .grid > div:after{
		content: " ";
		position: absolute;
		top: 0;
		bottom: 0;
		right: 0;
		width: 1px;
		background: #ddd;
	}

	.tab-section .content .grid.note > div{
		height: 80px;
		line-height: 80px;
	}

	.tab-section .content .grid .name{
		background: #f2f2f2;
		text-align: right;
	}

	.tab-section .content .grid .text .show-text{
		padding-left: 10px;
	}

	.tab-section .content .grid .text .edit-text{
		display: none;
		visibility: hidden;
		padding: 0 10px;
	}

	.tab-section .content .grid .text .edit-text > select{
		width: 30%;
		margin: 0 8px 0 0;
	}

	.tab-section .content .grid .text .edit-text > input{
		width: 93%;
		margin-bottom: 0;
	}

	.tab-section .content .grid .text .edit-text > textarea{
		width: 97%;
		height: 60px;
		margin-bottom: 0;
		resize: none;
	}

	@media (min-width: 1200px){
		.tab-section .content .grid .text .edit-text > select{
			width: 32%;
		}

		.tab-section .content .grid .text .edit-text > input{
			width: 95%;
		}

		.tab-section .content .grid .text .edit-text > textarea{
			width: 98%;
		}
	}

	.tab-section .content.business-edit .grid .text .show-text{
		display: none;
		visibility: hidden;
	}

	.tab-section .content.business-edit .grid .text .edit-text{
		display: block;
		visibility: visible;
	}

	.tab-section .content .record-process{
		margin: 20px 0 0 13px;
	}

	.tab-section .content .record-process > li{
		position: relative;
		min-height: 20px;
		border-left: 2px solid #0099ff;
		padding: 0 0 20px 150px;
	}

	.tab-section .content .record-process > li:before{
		content: "";
		position: absolute;
		top: 0;
		left: -8px;
		width: 10px;
		height: 10px;
		background: #0099ff;
		border-radius: 50%;
		border: 2px solid #fff;
	}

	.tab-section .content .record-process > li.current-process{
		border-left-color: #ddd;
	}

	.tab-section .content .record-process > li.current-process + li:before{
		background: #fff;
		border-color: #ddd;
	}

	.tab-section .content .record-process > li:first-child{
		height: 20px;
	}

	.tab-section .content .record-process > li:first-child:before{
		top: -5px;
		left: -13px;
		width: 20px;
		height: 20px;
		background: #fff;
		border: 3px solid #0099ff;
	}

	.tab-section .content .record-process > li:last-child{
		border-left-color: #fff;
	}

	.tab-section .content .record-process .process{
		position: absolute;
		left: 15px;
		top: -2px;
		color: #0099ff;
	}

	.tab-section .content .record-process > li.current-process + li .process{
		color: #999;
	}

	.tab-section .content .record-process > li > p{
		margin-bottom: 5px;
	}

	.tab-section .content .record-process > li > p:last-child{
		margin-bottom: 0;
	}

	.contact-user{
		text-align: center;
	}

	.contact-user .avatar{
		display: inline-block;
		border: 1px solid #ddd;
		padding: 3px;
	}

	.contact-user .avatar > a > img{
		width: 120px;
		height: 120px;
		border: 1px solid #ddd;
	}

	.contact-user .btn{
		margin-top: 5px;
	}

	.business-consultant{
		height: 40px;
		background: #eee;
		border: 1px solid #ddd;
		line-height: 40px;
		padding: 0 10px;
	}

	.business-state{
		border: 1px solid #ddd;
		margin: 10px 0 0 0;
		padding: 10px 10px 0 10px;
	}

	.business-state > p > span{
		color: #ff7900;
	}

	.business-control{
		height: 40px;
		background: #eee;
		border: 1px solid #ddd;
		line-height: 40px;
		margin-top: 10px;
		padding-left: 10px;
	}

	.business-control.others{
		/*text-align: left;*/
	}

	.business-notes{
		border: 1px solid #ddd;
		margin-top: 10px;
	}

	.business-notes .title{
		background: #eee;
		padding: 8px 10px;
	}

	.business-notes .content .business-note{
		border-bottom: 1px dashed #ddd;
		padding: 8px 10px;
	}

	.business-notes .content .business-note:last-child{
		border-bottom: 0;
	}

	.business-notes .content .business-note > p{
		margin-bottom: 0;
	}

	.business-notes .content .business-note > span{
		color: #999;
	}

	.business-control .control{
		color: #333;
		background: #fff;
		border: 1px solid #ddd;
		padding: 5px;
	}

	.business-control .control:hover{
		text-decoration: none;
	}

	.business-records{
		border: 1px solid #ddd;
		padding: 5px 10px;
	}

	.business-records .business-record{
		border-bottom: 1px dashed #ddd;
		margin-bottom: 5px;
	}

	.business-records .business-record > p{
		margin-bottom: 0;
	}

	.business-records .business-record > span{
		color: #999;
		margin-top: 5px;
	}

	.business-others{
		border: 1px solid #ddd;
		margin-top: 10px;
	}

	.business-others .title{
		background: #eee;
		padding: 8px 10px;
	}

	.business-others .business{
		border: 1px solid #ddd;
	}

	.business-others .business > table{
		width: 100%;
	}

	.business-others .business > table > thead > tr > td,
	.business-others .business > table > tbody > tr > td{
		border-bottom: 1px dashed #ddd;
		padding: 8px 5px;
	}

	.business-others .business > table > tbody > tr:last-child > td{
		border-bottom: 0;
	}

	.table > thead > tr > th{
		font-size: 14px;
		background: #eee;
		vertical-align: middle;
	}

	.list-inline {
		padding-left: 0;
		margin-left: -5px;
		list-style: none;
	}

	.list-inline > li {
		display: inline-block;
		padding-right: 5px;
		padding-left: 5px;
	}

	.list-unstyle{
		padding-left: 0;
		list-style: none;
	}

	.nomargin{
		margin: 0 !important;
	}

	.btn-dialog:hover{
		color: #00c0ef;
		text-decoration: none;
	}

	.businessnote{
	    /* position: static; */      
	    display: inline-block;
	    width: 90px;      
	    height: 20px;      
	    text-overflow: ellipsis;      
	    white-space: nowrap;      
	    overflow: hidden;
	}
	.business-control a {
		padding: 4px 15px;
	}
	.business-control a:first-child {
		display: inline-block;
		padding: 4px 12px;
		margin-bottom: 0;
		font-size: 14px;
		line-height: 20px;
		color: #ffffff;
		text-align: center;
		vertical-align: middle;
		cursor: pointer;
		background-color: #0099ff;
		background-repeat: repeat-x;
		border: 1px solid #bbb;
		border-color: #e6e6e6 #e6e6e6 #bfbfbf;
		border-color: rgba(0,0,0,0.1) rgba(0,0,0,0.1) rgba(0,0,0,0.25);
		border-bottom-color: #a2a2a2;
		-webkit-border-radius: 4px;
		-moz-border-radius: 4px;
		border-radius: 4px;
		filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffffff',endColorstr='#ffe6e6e6',GradientType=0);
		filter: progid:DXImageTransform.Microsoft.gradient(enabled=false);
		-webkit-box-shadow: inset 0 1px 0 rgba(255,255,255,0.2),0 1px 2px rgba(0,0,0,0.05);
		-moz-box-shadow: inset 0 1px 0 rgba(255,255,255,0.2),0 1px 2px rgba(0,0,0,0.05);
		box-shadow: inset 0 1px 0 rgba(255,255,255,0.2),0 1px 2px rgba(0,0,0,0.05);
	}
	}
	/*#cat1_select,#cat2_select,#cat3_select{
		width: 30%;
	}*/
	</style>
	<div class="aside-right">
		<div class="contact-user">
			<!--{/if $bschanceInfo.user_id/}
			<div class="avatar">
				<a href="/user/view-uid-{/$bschanceInfo.user_id/}" target="_blank">{/strip_tags($bschanceInfo.user_id|cpface:21:'middle','<img>')/}</a>
			</div>
			<p class="nomargin"><a href="/user/view-uid-{/$bschanceInfo.user_id/}" target="_blank">{/$bschanceInfo.unickname/}</a></p>
			{/else/}
			<div class="avatar">
				{/strip_tags($bschanceInfo.user_id|cpface:21:'middle','<img>')/}
			</div>
			{//if/}-->
			{/if !$bschanceInfo.taskList/}
			{/if service_rcba::checkAnAccess('crmchance','relationUser')/}
			<!--<p><a class="btn ajaxdialog" href="/crmchance/relationUser?id={/$bschanceInfo.bs_to_ct_id/}&ct_id={/$bschanceInfo.ct_id/}">关联用户</a></p>-->
			<!--<p><a class="btn" href="/crmchance/addchance?id={/$bschanceInfo.bs_to_ct_id/}&ct_id={/$bschanceInfo.ct_id/}">关联用户2</a></p>-->
			{//if/}
			{//if/}
		</div>
		<div class="business-consultant clearfix">
			<ul class="pull-right list-inline">
				{/if $bschanceInfo.follow_uid/}
					{/if !$bschanceInfo.is_giveup/}
					<li>
					{/if service_rcba::checkAnAccess('crmchance','changeManager')/}
						<a href="/crmchance/changeManager?id={/$bschanceInfo.bs_to_ct_id/}" class="ajaxdialog">更改</a>
						{//if/}
					</li>
					{//if/}
				{/else/}
				<li>
				{/if service_rcba::checkAnAccess('crmchance','allot')/}
					<a href="/crmchance/allot?id={/$bschanceInfo.bs_to_ct_id/}" class="ajaxask" asktext="您确定要执行分配？">分配</a>
					{//if/}
				</li>
				{//if/}
			</ul>
			商机顾问：{/if $bschanceInfo.follow_uid/}
			{/$bschanceInfo.follow_uid|cpuser:'all'/}
			{/else/}无{//if/}
		</div>
		<div class="business-state">
			<!-- 跟进状态 -->
			<p>跟进状态：{/if $bschanceInfo.allottime>0 && $bschanceInfo.followtime eq 0  && $bschanceInfo.is_giveup eq 0 &$bschanceInfo.ordertime eq 0/}
                	<strong>待受理</strong>
                	<p>跟进时间：
                		{/if strtotime($bschanceInfo.next_follow_time) gte time()/}
		                	{/if date("Y-m-d") eq date("Y-m-d",strtotime($bschanceInfo.next_follow_time))/}
		                	<span style="color:#F90"> 今天{/$bschanceInfo.next_follow_time|date_format:'%H:%M'/} 前跟进</span>
		                	{/else/}
		                	<span style="color:#F90"> {/$bschanceInfo.next_follow_time|date_format:'%Y-%m-%d %H:%M'/} 前跟进</span>
		                	{//if/}
		                {/else/}
		                	{/if date("Y-m-d") eq date("Y-m-d",strtotime($bschanceInfo.next_follow_time))/}
		                	<span style="color:red"> 今天{/$bschanceInfo.next_follow_time|date_format:'%H:%M'/} 已超期</span>
		                	{/else/}
		                	<span style="color:red"> {/$bschanceInfo.next_follow_time|date_format:'%Y-%m-%d %H:%M'/} 已超期</span>
		                	{//if/}
		                {//if/}
		                </p>
                	{/elseif $bschanceInfo.followtime>0 && $bschanceInfo.ordertime eq 0 && $bschanceInfo.is_giveup eq 0/}
                	<strong>跟进中</strong>
                	<p>跟进时间：
						{/if strtotime($bschanceInfo.next_follow_time) gte time()/}
		                	{/if date("Y-m-d") eq date("Y-m-d",strtotime($bschanceInfo.next_follow_time))/}
		                	<span style="color:#F90"> 今天{/$bschanceInfo.next_follow_time|date_format:'%H:%M'/} 前跟进</span>
		                	{/else/}
		                	<span style="color:#F90"> {/$bschanceInfo.next_follow_time|date_format:'%Y-%m-%d %H:%M'/} 前跟进</span>
		                	{//if/}
		                {/else/}
		                	{/if date("Y-m-d") eq date("Y-m-d",strtotime($bschanceInfo.next_follow_time))/}
		                	<span style="color:red"> 今天{/$bschanceInfo.next_follow_time|date_format:'%H:%M'/} 已超期</span>
		                	{/else/}
		                	<span style="color:red"> {/$bschanceInfo.next_follow_time|date_format:'%Y-%m-%d %H:%M'/} 已超期</span>
		                	{//if/}
		                {//if/}
					</p>
                	{/elseif $bschanceInfo.ordertime>0/}
                	<strong>已转化</strong>
                	{/elseif $bschanceInfo.is_giveup eq 1/}
                	<strong>已关闭</strong><a class="pull-right ajaxask" href="/crmchance-getit?id={/$bschanceInfo.bs_to_ct_id/}"  asktext="认领后该商机将锁定到你,是否要认领？">认领</a>
                	{/elseif $bschanceInfo.follow_uid eq 0/}
                	<strong>未分配</strong>
                	{//if/}</p>
		</div>
		{/if $bschanceInfo.is_giveup eq 0 && $bschanceInfo.allottime gt 0/}
		<div class="business-control">
			<a class="" target="_blank" href="/crmchance/addchance?id={/$bschanceInfo.bs_to_ct_id/}&ct_id={/$bschanceInfo.ct_id/} ">受理商机</a>
			{/if service_rcba::checkAnAccess('crmchance','follow')/}
			<a class="btn btn-default ajaxdialog follow" href="/crmchance-follow?id={/$bschanceInfo.bs_to_ct_id/}">跟进</a>
			<!--<a class="btn btn-default ajaxdialog extend-time" href="/crmchance-follow?id={/$bschanceInfo.bs_to_ct_id/}&change_followtime=1">延长跟进时间</a>-->

				{/if $bschanceInfo.ordertime eq 0/}
				<a class="btn btn-default ajaxdialog give-up" href="/crmchance-follow?id={/$bschanceInfo.bs_to_ct_id/}&is_giveup=1">关闭</a>
				{//if/}
			{//if/}
		</div>
		{//if/}
		<!--<div class="business-control others">
			{/if !$bschanceInfo.user_id/}
			{/if service_rcba::checkAnAccess('crmchance','HelpRegister')/}
			<a class="btn btn-default ajaxdialog follow" href="/crmchance/HelpRegister?id={/$smarty.get.id/}&ct_id={/$bschanceInfo.ct_id/}">代注册</a>
			{//if/}
			{//if/}
			{/if service_rcba::checkAnAccess('crmchance','pubtask')/}
				{/if $bschanceInfo.is_giveup eq 0/}
				<a class="btn btn-default ajaxdialog extend-time" href="/crmchance-pubtask?bs_to_ct_id={/$smarty.get.id/}">代发需求</a>
				{//if/}
			{//if/}
		</div>-->
		<!-- 备注信息 -->
		<div class="business-notes">
			<div class="title clearfix">
				备注
				<span class="pull-right"><a href="/crmchance/createnote?id={/$bschanceInfo.bs_to_ct_id/}" class="ajaxdialog" title="新建备注">新建</a></span>
			</div>
			<div class="content">
				{/if $showlogs/}
				{/foreach from=$showlogs item=log/}
				<div class="business-note">
					{/if $log.is_followlog eq 1/}
						{/if $log.is_giveup/}
							<p>#关闭#{/$giveupOptions[$log.giveup_option]/} : {/$log.giveup_reason_remark/}</p>
						{/else/}
							<p>＃跟进记录＃{/$followOptions[$log.follow_option]/}: {/$log.follow_remark/}</p>
						{//if/}
						<span>{/$log.follow_user_id|cpuser:'showname'/} 创建于{/$log.follow_time|date_format:"%Y-%m-%d %H:%M:%S"/}</span>
					{/elseif $log.is_optionlog eq 1/}
						<p>{/$log.note/}</p>
						<span>{/$log.create_uid|cpuser:'showname'/} 创建于{/$log.time|date_format:"%Y-%m-%d %H:%M:%S"/}</span>
					{//if/}
				</div>
				{//foreach/}
				{/else/}
				<div class="business-note">暂无</div>
				{//if/}
				<div class="clearfix"><a class="pull-right" href="/crmchance/detail?id={/$smarty.get.id/}&tab=followlog">查看所有</a></div>
			</div>
		</div>
		<div class="business-others">
			<div class="title">最近商机订单</div>
			<div class="business">
				{/if $otherList/}
				<table>
					<thead>
						<tr>
							<td>商机描述</td>
							<td>状态</td>
							<td>提交时间</td>
							<td>顾问</td>
						</tr>
					</thead>
					<tbody>
						{/foreach from=$otherList key="other_key" item="other"/}
						<tr>
							<td class="businessnote"><a href="/crmchance/detail?id={/$other.bs_to_ct_id/}">{/if $other.note/}{/$other.note/}{/else/}未描述{//if/}</a></td>
							<td>

							{/if $other.allottime>0 && $other.followtime eq 0 && $other.is_giveup eq 0  && $other.ordertime eq 0/}
		                	待受理
		                	{/elseif $other.followtime>0 && $other.ordertime eq 0 && $other.is_giveup eq 0/}
								{/if strtotime($other.next_follow_time) gte time()/}
		                			跟进中
				                {/else/}
				                	已超期
				                {//if/}
		                	{/elseif $other.ordertime>0 && $other.is_giveup eq 0/}
		                	已转化
		                	{/elseif $other.is_giveup eq 1/}
		                	已关闭
		                	{/elseif $other.follow_uid eq 0/}
		                	未分配
		                	{//if/}

							</td>
							<td style="text-align: center;">{/$other._createtime|date_format:" %m-%d "/}</td>
							<td>{/$other.follow_uid|cpuser:'name'/}</td>
						</tr>
						{//foreach/}
					</tbody>
				</table>
				{/if count($otherList) gt 5/}
					<!--<div class="clearfix"><a class="pull-right" style="margin-right:10px;margin-bottom:10px;" target="_blank" href="/user/bschance-uid-{/$bschanceInfo.user_id/}.html">查看所有</a></div>-->
				{//if/}

				{/else/}
				<div class="business-note" style="padding: 8px 10px;">暂无</div>
				{//if/}

			</div>
		</div>
	</div>
	<div class="detail-main">
		<ul class="nav nav-tabs">
			<li {/if $smarty.get.tab eq 'detail'/} class="active" {//if/} >
				<a href="/crmchance/detail?id={/$smarty.get.id/}&tab=detail">详细</a>
			</li>
			<li {/if $smarty.get.tab eq 'followlog'/} class="active" {//if/} >
				<a href="/crmchance/detail?id={/$smarty.get.id/}&tab=followlog">跟进记录</a>
			</li>
			<li {/if $smarty.get.tab eq 'log'/} class="active" {//if/} >
				<a href="/crmchance/detail?id={/$smarty.get.id/}&tab=log">日志</a>
			</li>
		</ul>
		<div class="tab-content">
			{/include file="crmchance/detail/tab_"|cat:$smarty.get.tab|cat:'.html'/}
		</div>
	</div>
</div>
{//capture/}
{/include file="common/zhubajietpl.html"/}
<script type="text/javascript">
var cat1_id = {/$bschanceInfo.base_cat1/};
var cat2_id = {/$bschanceInfo.base_cat2/};
var cat3_id = {/$bschanceInfo.base_cat3/};
{/if $cattree/}
var cattree=[];
{/else/}
var cattree=[];
{//if/}

$(document).ready(function (){
	//新的三级类目
	$(".cat select[name='cat1'],.cat select[name='cat2']").change(function(){
		var _this = $(this);
		var val = _this.val();
		var html='<option value="0">全部</option>';
		if(val!=0){
			$.getJSON("/apitask/getchildcategory",{"pid":val},function(d){
				var selval2="{/$bschanceInfo.base_cat2/}";
				var selval3="{/$bschanceInfo.base_cat3/}";
				_this.nextAll("select").html(html);
				for(var i=0;i<d.data.length;i++){
					var selhtml='';
					if(selval2==d.data[i]["category_id"]||selval3==d.data[i]["category_id"]){
						selhtml=' selected="selected" ';
					}
					html+='<option value="'+d.data[i]["category_id"]+'" '+selhtml+'>'+d.data[i]["category_name"]+'</option>';
				}
				_this.next("select").html(html);
				_this.next("select").change();
			});
		}else{
			_this.next("select").html(html);
			if($(".cat select[name='cat1']").val() == 0){
				$(".cat select[name='cat3']").html(html);
			}
		}
	});
	$(".cat select[name='cat1']").val('{/$bschanceInfo.base_cat1/}');
	$(".cat select[name='cat1']").change();
	
	
	
	
	var $select1 = $('#cat1_select');
	var $select2 = $('#cat2_select');
	var $select3 = $('#cat3_select');
	var $radioGroup = $('.radio-group');
	var $businessEdit = $('#J-business-edit');
	var $businessSave = $('#J-business-save');
	var $businessCancel = $('#J-business-cancel');
	var $crmchanceInfo = $('.crmchance-info'), cat1_name, cat2_name, cat3_name;

	// 意向类目
	var option=$('<option>');
	option.attr('value',0);
	option.text("请选择")
	$select1.append(option);
	$.each(cattree,function (index,item){
		var option=$('<option>');
		option.attr('value',item.guide_id);
		option.text(item.guide_name)
		$select1.append(option);
	});
	// $select1.trigger('change');

	$select1.bind('change',function (){
		$select2.empty();
		var option=$('<option>');
		option.attr('value',0);
		option.text("请选择")
		$select2.append(option);
		if($(this).val()==0){
			// cat1_id = 0;
			cat1_name = '';
			return false;
		}
		console.log("OK");
		cat1_id = $(this).val();
		data=cattree[$(this).val()];
		cat1_name = $(this).find('option:checked').text();

		$.each(data['list'],function (index,item){
			var option=$('<option>');
			option.attr('value',item.guide_id);
			option.text(item.guide_name)
			$select2.append(option);
		});
		$select2.val(cat2_id).change();
	});

	$select2.bind('change',function (){
		$select3.empty();
		var option=$('<option>');
		option.attr('value',0);
		option.text("请选择")
		$select3.append(option);
		if($(this).val()==0){
			cat2_name = '';
			$select3.trigger('change');
			return false;
		}
		cat2_id = $(this).val();
		var data=cattree[$select1.val()]['list'][$(this).val()];
		cat2_name = $(this).find('option:checked').text();

		data['list'] && $.each(data['list'],function (index,item){
			if (item.guide_name && item.guide_id) {
				var option=$('<option>');
				option.attr('value',item.guide_id);
				option.text(item.guide_name)
				$select3.append(option);
			}
		});
		$select3.val(cat3_id).change();
	});

	$select3.bind('change', function(){
		cat3_id = $(this).val();
		cat3_name = $(this).find('option:checked').text();
		if ($(this).val() == 0) {
			cat3_name = '';
		}
	});

	// 表单获取焦点事件
	$crmchanceInfo.on('focus', 'input, textarea', function(){
		var $this = $(this),
			$showText = $this.closest('.edit-text').siblings('.show-text');

		$showText.data('original-data', $showText.text() || '');
	});

	// 表单失去焦点事件
	$crmchanceInfo.on('blur', 'input, textarea', function(){
		var $this = $(this),
			$showText = $this.closest('.edit-text').siblings('.show-text');

		$showText.text($this.val());
	});

	// 商机信息编辑
	$businessEdit.bind('click', function(){
		$select1.val(cat1_id).change();
		$crmchanceInfo.addClass('business-edit');
		$businessEdit.closest('.list-inline').addClass('business-edit');
	});

	// 商机信息编辑后保存
	$businessSave.bind('click', function(){
		$crmchanceInfo.find('.cover').css('display', 'block');
		$.post('/crmchance-create?id={/$smarty.get.id/}', $crmchanceInfo.serialize(), function(data){
			$crmchanceInfo.find('.cover').css('display', 'none');
			if (data.state == 1) {
				var radios = $radioGroup.find('input[type="radio"]');
				for (var i = 0, len = radios.length; i < len; i++) {
					if (radios[i].checked) {
						$radioGroup.siblings('.show-text').text($(radios[i]).attr('data-name'));
						break;
					}
				}
				var cat1_name = '';
				var cat2_name = '';
				var cat3_name = '';
				if($(".cat select[name='cat1']")){
					cat1_name = $(".cat select[name='cat1'] option:selected").text();
				}
				if($(".cat select[name='cat2']")){
					cat2_name = $(".cat select[name='cat2'] option:selected").text();
				}
				if($(".cat select[name='cat3']")){
					cat3_name = $(".cat select[name='cat3'] option:selected").text();
				}
				$crmchanceInfo.find('.intent-category').text((cat1_name ? cat1_name : '') + (cat2_name ? ' > ' + cat2_name : '') + (cat3_name ? ' > ' + cat3_name : ''));
				$crmchanceInfo.removeClass('business-edit');
				$businessSave.closest('.list-inline').removeClass('business-edit');
				zbjkit.tips('保存成功！', 'success');
			} else {
				zbjkit.tips(data.msg, 'error');
			}
		}, 'json');
	});

	// 商机信息取消编辑
	$businessCancel.bind('click', function(){
		var showTexts = $crmchanceInfo.find('.show-text');
		for (var i = 1, len = showTexts.length; i < len; i++) {
			var $showText = $(showTexts[i]);
			$showText.text($showText.data('original-data'));
			if ($showText.siblings('.edit-text').find('textarea') && $showText.data('original-data')) {
				$showText.siblings('.edit-text').find('textarea').val($showText.data('original-data'));
			}
			if ($showText.siblings('.edit-text').find('input[type="text"]') && $showText.data('original-data')) {
				$showText.siblings('.edit-text').find('input[type="text"]').val($showText.data('original-data'));
			}
		};

		$crmchanceInfo.removeClass('business-edit');
		$businessCancel.closest('.list-inline').removeClass('business-edit');
	});
});
</script>
