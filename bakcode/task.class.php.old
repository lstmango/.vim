<?php

/**
 * 任务入口类
 */

class zbj_service_task {

	//交易类型
	public $type;

	//对象id
	public $id;

	//是否访问主库
	public $entry;

	/**
	 * 如果不指定实例化交易类型，将自动创建
	 * 为提高效率，最好指定任务类型
	 * @param int $id 任务ID
	 * @param string $type 交易类型，悬赏：contest,招标:bid,速配:match，自动识别:auto
	 * @param boolean $intime 是否需要访问主库的数据
	 */
	public function __construct($id = 0, $type = 'auto', $entry = false) {
		$this->setTYpe($type);
		$this->setId($id);
		$this->setDbEntry($entry);
	}

	/**
	 * 设置当前的交易类型
	 */
	public function setType($type) {
		$this->type = $type;
	}

	/**
	 * 设置交易ID
	 */
	public function setId($id) {
		$this->id = $id;
	}

	/**
	 * 设置是否访问主库
	 */
	public function setDbEntry($entry = true) {
		$this->entry = $entry;
	}

	/**
	 * 返回实例化的对象
	 * @return object
	 */
	public function init() {
		$class_name = 'zbj_service_task_'.$this->getType();
		var_dump($class_name);
		$obj = new $class_name($this->id);
		if($this->entry) $obj->setDbEntry();
		return $obj;
	}

	/**
	* 返回任务的交易类型
	* @return string
	*/
	public function getType() {
		if(empty($this->type) || strtolower($this->type) == 'auto') {
			$model = zbj_model_api::get('zbj_model_mk_task', $this->id);
			//暂时不强行指向主库 2012.5.29 有待观察，主要是更新操作怕因为主从同步受到影响
			if($this->entry) $model->setDbEntry();
			$result = $model->getData();
			if(in_array($result['mode'], array(6,7,8,9))) {
				//速配模式
				$this->type = 'match';
			}else if (in_array($result['mode'], array(1,2,3,4,5))) {
				//招标模式
				$this->type = 'bid';
			}else if (in_array($result['mode'], array(10))) {
				//免费模式
				$this->type = 'free';
			}else if (in_array($result['mode'], array(11,12))) {
				//T5服务交易
				$this->type = 'buy';
			}else if (in_array($result['mode'], array(13))) {
				//T6招标
				$this->type = 'newbid';
			}else {
				//悬赏模式
				$this->type = 'contest';
			}
		}
		return $this->type;
	}

}
