<?php

/**
 * 存储分配日志记录 20150508 by houxiaopeng
 */

class zbj_service_taskallotdaylog extends zbj_components_baseservice {
	//当前业务ID
	protected $id;
	//当前对象主数据表
	protected $marter_table = 'zbj_model_mk_taskallotdaylog';

	public function __construct($id = 0) {
		parent::__construct();
		$this->id = $id;
	}

    /**
	 * 存储分配日志记录
	 * @param	int	$manager_id
	 * @return bool
	 * */
	public function addTaskAllotDayLog(&$srvTask,$manager_id){
		if(!is_object($srvTask)){
			$this->setError(0,'数据格式错误，传入任务数据必须为对象！');
			return false;
		}
		$task = $srvTask->get('*');
		$taskid = intval($task['task_id']);
		if($taskid <= 0){
			$this->setError(0,'传入的需求编号错误');
			return false;
		}
		$manager_id = intval($manager_id);
		if($manager_id <= 0){
			$this->setError(0,'传入的交易顾问ID号错误');
			return false;
		}

		if(!$task['category_id']){
			$this->setError(0,'三级分类ID不存在');
			return false;
		}
		//获取交易顾问姓名和分组名
		$manager_obj = zbj_model_api::get('zbj_model_cp_user');
		$manager_res = $manager_obj->selectOne("user_id = $manager_id",'group_id,name');
		if(!$manager_res['group_id']){
			$this->setError(0,'未查找到交易顾问');
			return false;
		}
		
		$srvModuleConf = new zbj_service_moduleconfig();
		$module_config_res = $srvModuleConf->getTaskAllotDimensionConfig($srvTask);
		is_array($module_config_res) && $module_config_res = $module_config_res[0];
		if(!$module_config_res['dimension_id']){
			$this->setError(0,'未查找到分配规则ID号');
			return false;
		}
		$data = array(
               'task_id' => $task['task_id'],
               'user_id' => $task['user_id'],
               'nickname' => $task['nickname'],
               'manager_id' => $manager_id,
               'manager_name' => $manager_res['name'],
               'manager_teamid' => $manager_res['group_id'],
               'category_id' => $task['category_id'],
               'dimension_id' => $module_config_res['dimension_id'],
               'allottime' => time(),
               'allotymd' => date('Y-m-d',time())
			);

		$this->set($data);
		if(!$this->save()){
			$this->setError(0,'保存分配日志记录失败');
			return false;
		}else{
			return true;
		}

	}


    
	/**
	 * 获取需求上一次跟进的交易顾问
	 * @param	object	$srvTask
	 * @param	bool	$online
	 * @return array
	 * */
	public function getPreManager(&$srvTask){
		if(!is_object($srvTask)){
			$this->setError(0,'数据格式错误，传入任务数据必须为对象！');
			return false;
		}
		$task = $srvTask->get('*');
		if(empty($task['task_id'])) {
			$this->setError(0,'需求不存在');
			return false;
		}

		$user_id = intval($task['user_id']);
		if($user_id <= 0){
			$this->setError(0,'传入的雇主ID号错误');
			return false;
		}
		$module_config_obj = zbj_model_api::get('zbj_model_mk_moduleconfig');
		$module_config_res = $module_config_obj->selectOne("category_id = '{$task['category_id']}'",'dimension_id','','order by id desc');
        if(!$module_config_res['dimension_id']){
            $this->setError(0,'分配规则ID号错误');
			return false;
        }
		//七天604800
		$time = date('Y-m-d',strtotime('-7 day'));
		$condition = "user_id = $user_id and allotymd >= '$time' and dimension_id = {$module_config_res['dimension_id']}";
		$task_allot_log_res = $this->model()->selectOne($condition,'manager_id',null,'order by allotymd desc,log_id desc');
		//var_dump($task_allot_log_res);
                
		if($task_allot_log_res['manager_id']){
			#2015-10-21去掉验证是否有待审核订单
/*
 *                        $taskModel = zbj_model_api::get('zbj_model_mk_task');
 *                        $condi[] = zbj_lib_Constant::DOMAIN == 'zhubajie.com' ? 'task_id > 5000000' : 'task_id > 4000000';
 *                        $condi[] = "createymd > '" . date('Y-m-d', strtotime('-7 days')) . "'";
 *                        $condi[] = 'audit_state = 0';
 *                        $condi[] = "manager_id2 = '$task_allot_log_res[manager_id]'";
 *                        //$isAudit = $taskModel->selectOne($condi, 'count(1) as num');
 *
 *                        if($isAudit['num'] > 0){
 *                            $this->setError(0, '该顾问还有订单未审核,不允许分配订单');
 *                            return false;
 *                        }
 */
			return $task_allot_log_res['manager_id'];
		}
			
		return 0;
	}

}
