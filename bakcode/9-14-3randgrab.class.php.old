<?php
/*
 *订单分配系统-抢订单
 *lsTMango
 *2015-09-07
 */
class zbj_service_randgrab extends zbj_components_baseservice {
	private $userId;
	//选标率
	private $selectRate=0.5;//test
	//盲抢池任务
	private $taskArray=array();
	//待检测任务
	private $checkTask=array();
	//防御式code
	private $totalCycleNum=50;
	private $cycleNum=0;

	/*
	 *构造函数
	 */
	public function __construct($initData) {
        error_reporting(0);
		if($initData){
			foreach($initData as $initKey=>$initValue){
				$this->$initKey=$initValue;
			}
		}
		$stime=date("Y-m-01") ;
		$etime=date("Y-m-d") ;
		$this->stime=$stime;
		$this->etime=$etime;
        $this->dbinfo = 'market';
	}

	/*
	 *盲抢
	 */
	public function doGrab(){
		//判断是否ajax请求
	    if (!zbj_lib_BaseUtils::isAjax()) {
			#return 'no ajax';
		}
		//验证是否交易顾问
		$this->checkIdentity();
		//检测当天投标数量
		$this->checkGrabTotalNum();
		//检测选标率
		$this->checkSelectRate();
		//检测当前交易顾问是否有跟进订单
		$this->checkFollowTask();
		//获取盲抢池订单
		$this->getRandGrabPoolTask();
		$this->doGrabTask();
	}

	/*
	 *从盲抢池中随机取出一个符合规则订单
	 */
	private function getRandGrabPoolTask(){
		$taskAllotPoolModule = zbj_model_api::get('zbj_model_mk_taskallotpool');
		$condi[] = 'allotstate = 0 and needallot = 2';
		$condi[] = "next_chktime > '" . (time()-28*60) . "'";
		$grabTaskArray = $taskAllotPoolModule->select($condi, 'task_id')->items;
		if(!$grabTaskArray){
			return zbj_lib_BaseUtils::jsonp("暂时没有合适的订单哦，稍后再来试试吧！(●'◡'●)",1,0);
		}
		$taskIdArray = array();
		foreach($grabTaskArray as $tValue){
			$tid = intval($tValue['task_id']);
			$tid>0 && $taskIdArray[] = $tid;
		}
		$this->taskIdArray=$taskIdArray;
		$this->getRandCycleTask();
	}

	/*
	 *执行认领功能
	 */
	private function doGrabTask(){
		$taskId=$this->returnTaskId;
		$srvTask = new zbj_service_task($taskId);
		$srvTask = $srvTask->init();
		$toManager['filter']= 'grab';
		$toManager['manager']['manager_id']= $this->userId;
		//再验证将更改验证方式
		$taskAllotPoolModule = zbj_model_api::get('zbj_model_mk_taskallotpool');
		$condi[] = 'task_id='.$taskId;
		$lastCheckPoolType = $taskAllotPoolModule->selectOne($condi, 'needallot,allotstate');
		//再循环
		if( $lastCheckPoolType['needallot']==3 || ($lastCheckPoolType['needallot']==2 && $lastCheckPoolType['allotstate']=1) || ($lastCheckPoolType['needallot']==2 && $lastCheckPoolType['allotstate']=2)){
			$this->unsetPublcVar();
			$this->getRandCycleTask();
		}
		$grabData['task_id']=$taskId;
		$grabData['manager_id']=$this->userId;
		$grabData['type']=1;
		$insertBack=$this->insertGrabtask($grabData);
		//该订单已被抢
		if(!$insertBack){//待优化
			$this->unsetPublcVar();
			$this->getRandCycleTask();
		}

		$srvAlloter = new zbj_service_taskalloter();
		$allot_back=$srvAlloter->doAllot($srvTask,$toManager);
		$rError=$srvAlloter->getError();
		if($allot_back==true){
			return zbj_lib_BaseUtils::jsonp("需求认领成功!",1,1,array('task_id'=>$taskId));
		}
		else{
			$condition=array(
				'task_id'  => $taskId
			);
			$taskAllotGrabModule = zbj_model_api::get('zbj_model_mk_taskallotgrab');
			$delResult=$taskAllotGrabModule->delete($condition);				
			return zbj_lib_BaseUtils::jsonp("需求认领失败!",1,0);
		}
	}

	function test2(){
				$condition=array(
					'task_id'  => 12312
				);
				$taskAllotGrabModule = zbj_model_api::get('zbj_model_mk_taskallotgrab');
				$delResult=$taskAllotGrabModule->delete($condition);				
				var_dump($delResult);
	}
	function test(){
				$condition=array(
					'task_id'  => 12312
				);
				$grabData = array(
					'status'	=> 1
				);
				$taskAllotGrabModule = zbj_model_api::get('zbj_model_mk_taskallotgrab');
				$saveResult = $taskAllotGrabModule->update($condition,$grabData);
				var_dump($taskAllotGrabModule);
				var_dump($saveResult);
	}
	public function insertGrabtask($data){
		$taskAllotGrabModule = zbj_model_api::get('zbj_model_mk_taskallotgrab');
		if(empty($data['task_id']) || empty($data['manager_id'] || empty($data['type']))){
			//return zbj_lib_BaseUtils::jsonp("参数传递错误!",1,0);
			return false;
		}
		$data = array(
			'task_id'	=> $data['task_id'],
			'manager_id'		=> $data['manager_id'],
			'type'		=> $data['type'],
			'createtime'	=> time(),
		);
		$back = $taskAllotGrabModule->insert($data);
		return $back;
	}
	
	/*
	 *取符合规则的订单
	 */
	private function getRandCycleTask(){
		$taskIdArray=$this->taskIdArray;
		if(!$this->taskArray && $taskIdArray){
			$taskModule = zbj_model_api::get('zbj_model_mk_task');
			if( count($taskIdArray)>1 ){
				$taskIds=implode($taskIdArray,',');
				$condi[] = 't.task_id in ('.$taskIds.')';
			}
			else{
				$condi[] = 't.task_id = '.$taskIdArray[0];
			}
			$leftjoin = array(
				'mk_task_info as ti'=>'ti.task_id = t.task_id',
			);
			$item='t.manager_id,t.task_id,t.mode,t.state,t.open_state,ti.refund_type,ti.refund_state,t.hosted';
			$taskArray = $taskModule->_db->select('mk_task as t',$condi,$item,null,null,$leftjoin)->items;
			if(!$taskArray){
				return zbj_lib_BaseUtils::jsonp("数据获取失败！请稍后再试～(●'◡'●)",1,0);
			}
			$this->taskArray=$taskArray;
		}
		elseif($this->taskArray){
			$taskArray=$this->taskArray;
		}

		if(count($taskArray)<=0){
			return zbj_lib_BaseUtils::jsonp("暂时没有合适的订单哦，稍后再来试试吧！(●'◡'●)",1,0);
		}
		$randKey=array_rand($taskArray);
		$this->randKey=$randKey;
		$randTask=$taskArray[$randKey];
		$this->checkTask=$randTask;
		$checkResult=$this->checkTaskGrabRule();
		$cycleNum=$this->cycleNum;
		$cycleNum++;
		$this->cycleNum=$cycleNum;
		if($checkResult===true){
			$this->returnTaskId=$randTask['task_id'];
			return true;
		}
		else{
			$this->removeGrabPool($randTask['task_id']);
			$this->unsetPublcVar($randTask['task_id']);
			if($cycleNum>=$this->totalCycleNum){
				return zbj_lib_BaseUtils::jsonp("当前抢单人数太多，请稍后再试～(●'◡'●)",1,0);
			}
			$this->cycleNum=$cycleNum;
			$this->getRandCycleTask();
		}
	}

	/*
	 *从去除的数据中不符合规则的订单
	 */
	private function unsetPublcVar(){
		$taskIdArray=$this->taskIdArray;
		$taskArray=$this->taskArray;
		$randKey=$this->randKey;
		$randTask=$taskArray[$randKey];

		$delKey = array_keys($taskIdArray,$randTask['task_id']);
		unset($taskIdArray[$delKey[0]]);
		$this->taskIdArray=$taskIdArray;
		unset($taskArray[$randKey]);
		$this->taskArray=$taskArray;
		if( count($taskArray)<=0 ){
			return zbj_lib_BaseUtils::jsonp("暂时没有合适的订单哦，稍后再来试试吧～(●'◡'●)",1,0);
		}
	}

	/*
	 *从盲抢池中释放，不符合条件的需求
	 */
	public function removeGrabPool($taskId){
		$taskAllotPoolModule = zbj_model_api::get('zbj_model_mk_taskallotpool');
		$condition['task_id']=$taskId;
		$updateData['allotstate']=2;
		$saveResult = $taskAllotPoolModule->update($condition,$updateData);
		if ($saveResult === false){
			$taskAllotLog=new zbj_service_taskallotlog();
			$taskAllotLog->addTaskAllotLog($taskId,array("从盲抢池中移除失败「主动认领」:".$taskAllotPoolModule->getError()));
			return false;
		}
		return true;
	}

	/*
	 *验证是否符合盲抢规则
	 */
	private function checkTaskGrabRule(){
		$checkTask=$this->checkTask;
		if(!$checkTask){
			return zbj_lib_BaseUtils::jsonp("待检测任务获取失败！请稍后再试～(●'◡'●)",1,0);
		} 
		if($checkTask['mode']==13 && ($checkTask['state']>=3 || $checkTask['open_state']==1 
			|| $checkTask['refund_state']==2) ){
			return false;
		}
		if( ($checkTask['mode']==11 || $checkTask['mode']==12) && ($checkTask['hosted']==1 || $checkTask['state']==4 || $checkTask['open_state']==1) ){
			return false;
		}
		if($checkTask['mode']==10){
			return false;
		}
		return true;
	}

	/*
	 *检测是否有待跟进订单
	 */
	private function checkFollowTask(){
		$taskAllotRoleModule = zbj_model_api::get('zbj_model_mk_taskallotrole');
		$condi[] = 'manager_id ='.$this->userId;
		$allotRole = $taskAllotRoleModule->selectOne($condi, 'need_follow_num');
		if(!$allotRole){
			return zbj_lib_BaseUtils::jsonp("获取待受理订单数量失败～(●'◡'●)",1,0);
		}
		$need_follow_num=$allotRole['need_follow_num'];
		if($need_follow_num>0){
			return zbj_lib_BaseUtils::jsonp("您当前有待受理订单，请先处理已分配给你的订单再来认领哦！(●'◡'●)",1,0);
		}
		return true;
	}

	/*
	 *验证是否交易顾问
	 */
	private function checkIdentity(){
		$userId=$this->userId;
		$allot=new zbj_service_taskalloter();
		$allManager=$allot->getAllManager(false);
		$manages = array();
		foreach($allManager as $manage){
			$mid = intval($manage['manager_id']);
			$mid>0 && $manages[] = $mid;
		}
		if(!in_array($userId,$manages)){
			return zbj_lib_BaseUtils::jsonp("您不是交易顾问，无法认领订单～(●'◡'●)",1,0);
		}
		return true;
	}

	/*
	 *检测选标率
	 */
	public function checkSelectRate(){
        $cache = new zbj_lib_cache('memcache');
        $cache_key = 'task.zhubajie.com.app.controller.crontab.managersummary.getManagerSummary';
		$cacheData=$cache->get($cache_key);
		var_dump($cacheData);
		$userCacheData=$cacheData['manager'][$this->userGroupid][$this->userId];
		if($userCacheData && $userCacheData['allot']['count']){
			$allotCount=$userCacheData['allot']['count'];
		}
		else{
			$allotCount=$this->_getAllotSummary($this->userId);
			$allotCount=$allotCount['count'];
		}
		if($userCacheData && $userCacheData['selected']['count']){
			$allotCount=$userCacheData['selected']['count'];
		}
		else{
			$selectCount=$this->_getSelectedSummary($this->userId);
			$selectCount=$selectCount['count'];
		}
		var_dump($cache);
		var_dump($selectCount);
		if($allotCount<=0){
			return zbj_lib_BaseUtils::jsonp("您当前选标率过低，无法认领订单～(●'◡'●)",1,0);
		}
		$selectRate=round( $selectCount/$allotCount,2 );
		if($selectRate<$this->selectRate){
			return zbj_lib_BaseUtils::jsonp("您当前选标率过低，无法认领订单～(●'◡'●)",1,0);
		}
		return true;
	}

    private function _getUids($uid, $gid){
        if(empty($gid) && empty($uid)){
            return false;
        }
        if(empty($uid) && $gid){
            $uid = $this->_getUserIdBygid($gid, true);
        }
        if(!is_array($uid)){
            $uid = array($uid);
        }
        $uid = array_filter($uid);
        if(empty($uid)) {
            return false;
        }
        return $uid;
    }

    private function _optManagerId($fields, $uids)
    {
        if(empty($uids)){
            return "1 ("; //排除所有直接跑错
        }
        if(count($uids) == 1){
            return "{$fields} = '{$uids[0]}'";
        }
        return sprintf("{$fields} in (%s)", join(',', $uids));
    }

	/*
     *已选标
	 */
    private function _getSelectedSummary($uid = '', $gid = '', $list = array())
    {
        $uid = $this->_getUids($uid, $gid);

        $mWork = new zbj_model_mk_works();
        $mTask = new zbj_model_mk_task();
        $join = array(
            'mk_task'=>'mk_task.task_id=mk_works.task_id',
            'mk_task_extends'=>'mk_task_extends.task_id=mk_task.task_id'
        );

        $condi = array();
        $condi[] = $this->_optManagerId('mk_task.manager_id', $uid);
        $condi[] = 'mk_task.state >= 3';
        $condi[8] = 'case when mk_task_extends.giveuptime > 0 then mk_task_extends.giveuptime >= 10800 + mk_task_extends.first_effect_follow_time else mk_task.state >= 3 end and mk_task_extends.giveuptype != 1';
        
		$count  = 0;
		$amount = 0;
		$distinct = 'DISTINCT';

		$condi[4] = "mk_works.select_ymd >= '{$this->stime}'";
		$condi[5] = "mk_works.select_ymd <= '{$this->etime}'";
		$condi[3] = 'mk_task.mode = 13';

		$data = $mWork->selectOne($condi, "count({$distinct} mk_task.task_id) as count,sum(mk_task.hosted_amount) as amount",'', '', $join, array('dbinfo'=>$this->dbinfo));
		$count += $data['count'];
		$amount += $data['amount'];

		$condi[4] = "mk_task.hosted_date >= '{$this->stime}'";
		$condi[5] = "mk_task.hosted_date <= '{$this->etime}'";
		$condi[3] = 'mk_task.mode in (11,12)';
		$condi[6] = "mk_task.hosted_amount > 0";

		$data = $mTask->selectOne($condi, 'count(1) as count,sum(mk_task.hosted_amount) as amount','', '', array('mk_task_extends'=>'mk_task_extends.task_id=mk_task.task_id'), array('dbinfo'=>$this->dbinfo));

		$count += $data['count'];
		$amount += $data['amount'];

		$condi[4] = "mk_works.select_ymd >= '{$this->stime}'";
		$condi[5] = "mk_works.select_ymd <= '{$this->etime}'";
		$condi[3] = 'mk_task.mode = 10';
		unset($condi[6]);

		$mWork->setCount(false);
		$data = $mWork->select($condi, 'mk_task.task_id,mk_task.hosted_amount','', '', $join, array('dbinfo'=>$this->dbinfo))->items;            

		if($data){
			$task_ids = array();
			foreach($data as $val){
				if($val['task_id'] && !in_array($val['task_id'], $task_ids)) {
					$task_ids[] = $val['task_id'];
					$amount += $val['hosted_amount'];
					$count += 1;
				}
			}
		}
		return array('count'=>$count, 'amount'=>$amount);
    }

	/*
     *查分配 
	 */
    private function _getAllotSummary($uid = '', $gid = '', $list = array())
    {
        $uid = $this->_getUids($uid, $gid);

        $mTask = new zbj_model_mk_task();
        $condi = array();
        $condi[] = $this->_optManagerId('mk_task.manager_id', $uid);
        $condi[] = "mk_task.open_state = 0";
        $condi[] = "mk_task.createymd >= '{$this->stime}'";
        $condi[] = "mk_task.createymd <= '{$this->etime}'";

		$data = $mTask->selectOne($condi, 'count(1) as count,sum(mk_task.amount) as amount','','','',array('dbinfo'=>$this->dbinfo));
        return $data;
    }

	/*
	 *将池子中的需求推到审核系统进行分配
	 */
	public function releaseFromGrabPoolToVerify($limit=30){
		$limit = intval($limit);
		($limit>50||$limit<=0) && $limit = 20;

		$taskpoolModel= zbj_model_api::get('zbj_model_mk_taskallotpool');
		$taskpoolModel->setLimit($limit);
		
		$nowtime = time();
		$condition = array(
			'needallot'		=> 2,
			'allotstate'	=> 0,
		);
		$condition[] = "next_chktime <= '" . (time()-30*60) . "' and next_chktime>='".(time()-30*24*3600)."'";

		$datalist = $taskpoolModel->select($condition,'task_id','','order by next_chktime asc')->items;
		$datalist = (array)$datalist;
		
		$taskids = array();
		foreach($datalist as $row){
			$tid = intval($row['task_id']);
			$tid>0 && $taskids[] = $tid;
		}
		if(empty($taskids)) return true;
                
		$upall = array(
			'needallot'		=> 3,
			'allotstate'	=> 0,
		);

		$result = $taskpoolModel->update('task_id in('.implode(',',$taskids).')',$upall);
		if($result === false){
			return false;
		}

		foreach($taskids as $tid){
			if(zbj_lib_Api::taskVerifyManager($tid) !== true){
				throw new Exception(zbj_lib_Api::getError());
			}
		}
		return true;
	}

}
