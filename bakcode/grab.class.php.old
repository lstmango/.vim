<?php
/*
 *订单分配系统-抢订单
 *@author lsTMango
 *@date 2015-09-07
 */
class consumer_service_allot_grab extends components_baseservice{
	
	//当前业务主数据表
	protected $marter_table = 'zbj_model_mk_pool';
	
	public function __construct($id=0){
		parent::__construct();
		$this->setId($id);
	}
	
	/*
	 *从盲抢池中释放，不符合条件的需求
	 *仅供事件触发
	 */
	public function removeGrabPool($data){
		$data['task_id'] = intval($data['task_id']);
		if($data['task_id'] < 4800000) return true;
		$taskAllotPoolModule = zbj_model_api::get('zbj_model_mk_taskallotpool');
		$condi[] = 'task_id='.$data['task_id'];
		$taskpool = $taskAllotPoolModule->selectOne($condi, 'needallot,allotstate');
		if(!$taskpool){
			throw new Exception("该需求[{$data['task_id']}]在池中不存在");
		}
		$sGrb=new zbj_service_randgrab();
		if($taskpool['needallot']==2 && $taskpool['allotstate']==0){
			$result=$sGrb->removeGrabPool($data['task_id']);
			return $result;
		}
		return true;
	}

}
